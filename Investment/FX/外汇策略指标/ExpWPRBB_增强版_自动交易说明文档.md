# ExpWPRBB增强版自动交易EA说明文档

## 1. EA概述

ExpWPRBB增强版是一款基于威廉指标(WPR)和布林带(BB)双重确认的自动化交易EA。该EA通过结合两种技术指标的信号，生成更可靠的交易信号，同时集成了完善的止盈止损机制、风险管理功能和交易记录系统。

## 2. 核心策略原理

### 2.1 信号生成机制

- **威廉指标(WPR)信号**：
  - 买入信号：WPR从下向上突破超卖区（WPR值从低于超卖阈值变为高于）
  - 卖出信号：WPR从上向下跌破超买区（WPR值从高于超买阈值变为低于）
  - 超买超卖阈值可通过`InpWPROverbought`和`InpWPROversold`参数调整

- **布林带(BB)信号**：
  - 买入信号：价格低于布林带中轨与下轨的中间值
  - 卖出信号：价格高于布林带中轨与上轨的中间值
  - 布林带参数可通过`InpBBPeriod`和`InpBBStandardDeviation`调整

- **综合信号逻辑**：
  1. 基础逻辑：当两个指标信号一致时生成交易信号
  2. 增强逻辑：如果启用高级过滤(`InpUseAdvancedFilter`)，且WPR信号强烈（超买超卖区域边界内进一步确认），即使布林带无信号也可交易

## 3. 止盈止损机制

### 3.1 止损设置

该EA提供两种止损设置方式：

1. **固定止损**：通过`InpStopLoss`参数设置固定的止损点数
2. **动态止损**：基于布林带宽度自动计算止损点数
   - 计算公式：`止损点数 = 布林带半宽度 * InpSLMltp`
   - 布林带半宽度根据当前市场波动性自动调整
   - `InpSLMltp`为止损倍数参数，可调整动态止损的敏感度

### 3.2 止盈设置

该EA提供两种止盈设置方式：

1. **固定止盈**：通过`InpTakeProfit`参数设置固定的止盈点数
2. **动态止盈**：基于ATR(平均真实范围)指标自动计算止盈点数
   - 计算公式：`止盈点数 = ATR值 * InpTPMltp / 最小价格变动单位(Point)`
   - ATR值根据市场波动自动调整
   - `InpTPMltp`为止盈倍数参数，可调整动态止盈的敏感度

### 3.3 止盈止损优先级

- 当`InpStopLoss > 0`时，使用固定止损
- 当`InpStopLoss < 0`时，使用动态止损
- 当`InpTakeProfit > 0`时，使用固定止盈
- 当`InpTakeProfit < 0`时，使用动态止盈
- 对于净值账户(`netto`)，将自动禁用止损止盈

## 4. 主要参数设置

### 4.1 指标参数

- `InpWPRPeriod`：威廉指标周期，默认值：14
- `InpWPROverbought`：WPR超买阈值，默认值：-20
- `InpWPROversold`：WPR超卖阈值，默认值：-80
- `InpBBPeriod`：布林带周期，默认值：20
- `InpBBStandardDeviation`：布林带标准差倍数，默认值：2.0
- `InpATRPeriod`：ATR指标周期，默认值：14

### 4.2 交易参数

- `InpMagic`：EA魔术数字，用于识别EA创建的订单，默认值：123456
- `InpLot`：固定交易手数，默认值：0.1
- `InpRiskPercent`：按账户风险百分比计算手数，默认值：1.0
- `InpStopLoss`：固定止损点数，负值表示使用动态止损，默认值：-1
- `InpTakeProfit`：固定止盈点数，负值表示使用动态止盈，默认值：-1
- `InpSLMltp`：动态止损倍数，默认值：1.0
- `InpTPMltp`：动态止盈倍数，默认值：2.0
- `InpDeviation`：价格偏差，默认值：5
- `InpMaxPositions`：最大持仓数限制，默认值：5
- `InpEnableCloseOpposite`：信号相反时是否平掉反向持仓，默认值：true
- `InpSignalsOnly`：仅显示信号模式（不执行交易），默认值：false
- `InpUseAdvancedFilter`：启用高级信号过滤，默认值：false
- `InpMaxConsecutiveLosses`：最大连续亏损次数限制，默认值：5

### 4.3 日志参数

- `InpLogSignals`：记录信号日志，默认值：true
- `InpLogTrades`：记录交易日志，默认值：true
- `InpLogErrors`：记录错误日志，默认值：true

## 5. 风险管理功能

1. **连续亏损保护**：当连续亏损次数达到`InpMaxConsecutiveLosses`设定值时，EA将暂停交易
2. **资金管理**：可选择固定手数或按账户风险百分比自动计算手数
3. **最大持仓限制**：通过`InpMaxPositions`限制同时持有的最大订单数
4. **止损止盈保护**：完善的止损止盈机制确保单笔交易风险可控
5. **交易环境检查**：交易前自动检查环境状态，确保交易安全

## 6. 交易执行流程

1. **数据获取**：获取价格数据和所有指标数据（WPR、布林带、ATR）
2. **信号生成**：分别计算WPR信号和布林带信号，然后生成综合信号
3. **信号显示**：在图表上显示买卖信号箭头
4. **风险管理检查**：检查连续亏损次数是否超过限制
5. **交易执行**：
   - 如有相反方向持仓且启用了反向平仓，则先平仓
   - 检查当前K线是否已有同方向持仓
   - 检查价格是否优于上次开仓价格
   - 执行开仓交易，设置止盈止损
   - 更新持仓列表

## 7. 图表显示功能

- WPR信号：在价格位置显示蓝色（买入）或红色（卖出）箭头
- 布林带信号：在布林带相应位置显示箭头（买入信号在下轨附近，卖出信号在上轨附近）
- 信号标记为隐藏状态，避免被鼠标选择和移动

## 8. 日志系统

- 提供详细的日志记录功能，包括信号生成、交易执行、错误信息等
- 日志包含时间戳、交易品种和具体信息，方便后续分析
- 可通过参数控制是否记录信号、交易和错误日志

## 9. 使用建议

1. **参数优化**：
   - 根据不同交易品种和时间周期调整指标参数
   - 动态止损止盈通常比固定值更适应市场波动
   - 建议在回测环境中优化参数后再实盘使用

2. **风险控制**：
   - 初始使用时建议设置较小的风险百分比（如0.5%）
   - 合理设置最大持仓数和连续亏损限制
   - 监控EA运行状态，定期检查日志

3. **市场选择**：
   - 适合有一定波动性的市场
   - 建议在中等时间周期（如H1、H4）使用
   - 避免在重大经济数据发布等高波动时期使用

## 10. 注意事项

1. 使用前确保MT5平台已启用自动交易功能
2. 交易账户需有足够资金以支持设定的风险水平
3. 定期备份交易日志以便分析EA表现
4. 市场条件变化时及时调整参数设置
5. 净值账户会自动禁用止损止盈，请特别注意风险控制

## 11. 常见问题解答

**Q: EA不执行交易怎么办？**
A: 检查以下几点：
- 是否已启用MT5的自动交易功能
- `InpSignalsOnly`参数是否设置为false
- 账户资金是否充足
- 查看日志是否有错误提示

**Q: 如何选择合适的止盈止损参数？**
A: 建议通过以下方式确定：
- 分析交易品种的历史波动性
- 使用动态止损止盈（参数设为负值）通常效果更好
- 回测不同参数组合，找到最优设置

**Q: 什么是高级信号过滤？**
A: 高级信号过滤允许在WPR信号非常强烈时，即使布林带没有信号也可以交易，增加了交易机会但可能降低信号质量。

---

本说明文档对应ExpWPRBB_增强版_自动交易.mq5，最后更新时间：2023年11月