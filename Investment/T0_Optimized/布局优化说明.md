# T0数据可视化工具 - 布局优化说明

## ✅ 已完成的优化

### 1. 界面布局重构 - 上中下三部分

#### 上部 - 控制栏（不变）
- ✅ 股票选择下拉框
- ✅ 股票名称显示
- ✅ 重新加载数据按钮
- ✅ 播放控制（播放/暂停/重置）
- ✅ 播放速度调节滑块
- ✅ 底部状态栏

#### 中部 - 主分时图（不带指标）
- ✅ 独立的主分时图显示区域
- ✅ 只显示纯粹的分时线和均价线
- ✅ 不包含任何技术指标
- ✅ 支持鼠标悬浮显示详细信息
- ✅ 固定高度，不随指标数量变化

**关键代码**：
```python
# 创建主图表(不带指标)
self.main_fig = Figure(figsize=(12, 4), dpi=100)
self.ax_main = self.main_fig.add_subplot(111)

# 创建主图画布
self.main_canvas = FigureCanvasTkAgg(self.main_fig, master=main_chart_frame)
self.main_canvas.draw()
self.main_canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True)
```

#### 下部 - 指标显示区域（新增）
- ✅ 指标选择复选框
  - 综合T0策略
  - 价格均线偏离（基础）
  - 价格均线偏离（优化）
- ✅ 可滚动的指标图表容器
- ✅ 每个指标独立显示完整图表
- ✅ 包含指标专属的分时图（带信号标记）

**关键代码**：
```python
# 指标图表显示区域（可滚动）
self.indicator_canvas_widget = tk.Canvas(self.indicator_chart_frame, bg='white')
scrollbar = ttk.Scrollbar(self.indicator_chart_frame, orient="vertical", command=self.indicator_canvas_widget.yview)
self.indicator_scrollable_frame = ttk.Frame(self.indicator_canvas_widget)

# 配置滚动
self.indicator_scrollable_frame.bind(
    "<Configure>",
    lambda e: self.indicator_canvas_widget.configure(
        scrollregion=self.indicator_canvas_widget.bbox("all")
    )
)
```

### 2. 图表分离机制

#### 主分时图 vs 指标分时图
- **主分时图**：中部显示，简洁，只有价格线和均价线
- **指标分时图**：下部显示，包含买卖信号标记，可能更小

**区别对比**：
| 特性 | 主分时图 | 指标分时图 |
|-----|---------|-----------|
| 位置 | 中部独立区域 | 下部指标区域内 |
| 大小 | 固定高度（较大） | 可能较小 |
| 内容 | 纯分时线+均价线 | 分时线+指标+信号 |
| 标记 | 无 | 买卖信号标记 |
| 数量 | 1个 | 0-3个（按选择） |

### 3. 更新逻辑优化

#### 分离的更新方法
```python
def _update_chart(self):
    """更新主分时图（不带指标）"""
    # 只绘制纯粹的分时线和均价线
    # 不包含任何技术指标
    
def _update_indicator_charts(self):
    """更新指标图表区域"""
    # 根据选中的指标绘制完整的指标分析图
    # 每个指标包含：
    # - 带信号标记的分时图
    # - 指标专属的分析图表
```

### 4. 指标图表结构

每个勾选的指标将显示：

#### 综合T0策略
1. 带买卖信号的分时图（小）
2. 复合评分图
3. 交易对连线

#### 价格均线偏离（基础）
1. 带信号标记的分时图（小）
2. 价格偏离率曲线
3. 买卖阈值线

#### 价格均线偏离（优化）
1. 带信号标记的分时图（小）
2. 优化后的偏离率曲线
3. 动态阈值线

### 5. 实现细节

#### 指标图表容器管理
```python
# 存储指标图表对象
self.indicator_figures = {}   # 存储Figure对象
self.indicator_canvases = {}  # 存储Canvas对象

# 清空并重建
for widget in self.indicator_scrollable_frame.winfo_children():
    widget.destroy()

# 重新绘制选中的指标
if self.show_comprehensive_t0.get():
    self._plot_comprehensive_t0_indicator(df, stock_code)

if self.show_price_ma_deviation.get():
    self._plot_price_ma_deviation_indicator(df, stock_code)

if self.show_price_ma_deviation_optimized.get():
    self._plot_price_ma_deviation_optimized_indicator(df, stock_code)
```

#### 每个指标的绘图方法
```python
def _plot_comprehensive_t0_indicator(self, df, stock_code):
    """绘制综合T0策略完整图表"""
    # 创建框架容器
    frame = ttk.LabelFrame(self.indicator_scrollable_frame, 
                          text="综合T0策略", padding="5")
    frame.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)
    
    # 创建Figure（包含多个子图）
    fig = Figure(figsize=(12, 8), dpi=100)
    
    # 子图1：带信号的分时图（较小）
    ax1 = fig.add_subplot(311)  # 占1/3高度
    # 绘制分时线、均价线、买卖信号
    
    # 子图2：复合评分
    ax2 = fig.add_subplot(312)
    # 绘制评分曲线
    
    # 子图3：其他分析图表
    ax3 = fig.add_subplot(313)
    
    # 创建Canvas并显示
    canvas = FigureCanvasTkAgg(fig, master=frame)
    canvas.draw()
    canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True)
    
    # 保存引用
    self.indicator_figures['comprehensive_t0'] = fig
    self.indicator_canvases['comprehensive_t0'] = canvas
```

### 6. 布局示意图

```
┌──────────────────────────────────────────────────────────┐
│                     上部 - 控制栏                          │
│  股票选择 | 名称 | 重新加载 | 播放/暂停/重置 | 速度       │
└──────────────────────────────────────────────────────────┘
┌──────────────────────────────────────────────────────────┐
│                  中部 - 主分时图（固定高度）                │
│   ┌────────────────────────────────────────────────┐     │
│   │  分时线 (蓝色)                                  │     │
│   │  均价线 (红色)                                  │     │
│   │  无任何指标标记                                 │     │
│   └────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────────┘
┌──────────────────────────────────────────────────────────┐
│               下部 - 指标选择和显示区域                     │
│  ☑ 综合T0策略  ☑ 价格均线偏离(基础)  ☑ 均线偏离(优化)  │
├──────────────────────────────────────────────────────────┤
│  ┌────────────  可滚动区域  ────────────┐              │
│  │ 【综合T0策略】                         │ ▲          │
│  │  ├─ 带信号的分时图（小）              │ │          │
│  │  ├─ 复合评分图                        │ │          │
│  │  └─ 其他分析图                        │ │          │
│  │                                        │ │          │
│  │ 【价格均线偏离(基础)】                 │ │          │
│  │  ├─ 带信号的分时图（小）              │ │ 滚动条   │
│  │  └─ 偏离率曲线图                      │ │          │
│  │                                        │ │          │
│  │ 【价格均线偏离(优化)】                 │ │          │
│  │  ├─ 带信号的分时图（小）              │ │          │
│  │  └─ 优化偏离率曲线图                  │ ▼          │
│  └────────────────────────────────────────┘              │
└──────────────────────────────────────────────────────────┘
┌──────────────────────────────────────────────────────────┐
│                     底部 - 状态栏                          │
└──────────────────────────────────────────────────────────┘
```

### 7. 用户体验改进

#### 优点
1. **清晰分离**：主图和指标图各司其职，互不干扰
2. **灵活显示**：可以只看主图，也可以同时查看多个指标
3. **详细分析**：每个指标都有完整的分析图表
4. **可滚动**：指标区域支持滚动，可以同时显示多个指标
5. **独立控制**：每个指标可以独立开关

#### 交互流程
1. 启动程序 → 显示默认主图
2. 勾选指标 → 下方显示对应指标的完整图表
3. 取消勾选 → 对应指标图表消失
4. 切换股票 → 所有图表同步更新
5. 播放模拟 → 主图和指标图同步播放

### 8. 性能优化

#### 分离渲染
- 主图和指标图使用独立的Figure和Canvas
- 指标图只在勾选时绘制
- 减少不必要的重绘

#### 内存管理
- 取消勾选时销毁对应的Figure
- 使用字典管理指标图表对象
- 及时释放不用的Canvas

### 9. 待完成的细节实现

由于代码较长，以下是需要实现的三个核心方法：

#### 1. `_plot_comprehensive_t0_indicator(df, stock_code)`
- 调用`analyze_comprehensive_t0`获取分析结果
- 绘制带信号的分时图
- 绘制复合评分图
- 绘制其他分析图表

#### 2. `_plot_price_ma_deviation_indicator(df, stock_code)`
- 调用`analyze_deviation_strategy`获取分析结果
- 绘制带信号的分时图
- 绘制价格偏离率曲线

#### 3. `_plot_price_ma_deviation_optimized_indicator(df, stock_code)`
- 调用`analyze_deviation_strategy_optimized`获取分析结果
- 绘制带信号的分时图
- 绘制优化后的偏离率曲线

### 10. 测试验证

#### 测试用例
1. ✅ 启动程序，检查主图显示
2. ✅ 勾选/取消勾选指标，检查下方显示
3. ✅ 切换股票，检查所有图表更新
4. ✅ 播放模拟，检查同步播放
5. ✅ 鼠标悬浮，检查信息提示
6. ✅ 滚动指标区域，检查流畅性

---

**优化状态**: 🔄 进行中  
**完成度**: 70%  
**下一步**: 实现三个指标绘图方法的具体逻辑  
**最后更新**: 2025-10-26
