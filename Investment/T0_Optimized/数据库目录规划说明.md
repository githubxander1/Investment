# æ•°æ®åº“ç›®å½•è§„åˆ’è¯´æ˜

## ğŸ“ æ–°çš„ç›®å½•ç»“æ„

### å®é™…ç»“æ„

```
db/
â”œâ”€â”€ stocks/                    # è‚¡ç¥¨æ•°æ®ï¼ˆæŒ‰è‚¡ç¥¨ã€å¹´ä»½ã€æœˆä»½åˆ†å±‚ï¼‰
â”‚   â”œâ”€â”€ 000333/               # ç¾çš„é›†å›¢
â”‚   â”‚   â””â”€â”€ 2025/
â”‚   â”‚       â””â”€â”€ 202510.db    # 2025å¹´10æœˆçš„æ•°æ®
â”‚   â”œâ”€â”€ 600030/               # ä¸­ä¿¡è¯åˆ¸
â”‚   â”‚   â””â”€â”€ 2025/
â”‚   â”‚       â””â”€â”€ 202510.db
â”‚   â””â”€â”€ 002415/               # æµ·åº·å¨è§†
â”‚       â””â”€â”€ 2025/
â”‚           â””â”€â”€ 202510.db
â”‚
â”œâ”€â”€ signals/                   # äº¤æ˜“ä¿¡å·æ•°æ®åº“
â”‚
â”œâ”€â”€ config/                    # ç³»ç»Ÿé…ç½®æ•°æ®åº“
â”‚
â”œâ”€â”€ archive/                   # å½’æ¡£æ—§æ•°æ®
â”‚
â””â”€â”€ t0_trading.db             # æ—§çš„å•ä½“æ•°æ®åº“ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰
```

### æ•°æ®åº“æ–‡ä»¶å†…éƒ¨ç»“æ„

æ¯ä¸ªæœˆåº¦æ•°æ®åº“ï¼ˆå¦‚ `202510.db`ï¼‰å†…éƒ¨æŒ‰å¤©åˆ†è¡¨ï¼š

```sql
-- 202510.db å†…éƒ¨è¡¨ç»“æ„
day_20251001  -- 10æœˆ1æ—¥çš„æ•°æ®
day_20251002  -- 10æœˆ2æ—¥çš„æ•°æ®
...
day_20251024  -- 10æœˆ24æ—¥çš„æ•°æ®
...
day_20251031  -- 10æœˆ31æ—¥çš„æ•°æ®
```

## ğŸ¯ è®¾è®¡ä¼˜åŠ¿

### 1. åˆ†å±‚å­˜å‚¨
```
è‚¡ç¥¨ç»´åº¦ â†’ å¹´ä»½ç»´åº¦ â†’ æœˆä»½ç»´åº¦ â†’ æ—¥è¡¨
000333   â†’ 2025   â†’ 202510.db â†’ day_20251024
```

**ä¼˜åŠ¿**ï¼š
- âœ… å•ä¸ªæ•°æ®åº“æ–‡ä»¶ä¸ä¼šå¤ªå¤§ï¼ˆæ¯ä¸ªæœˆçº¦2-5MBï¼‰
- âœ… ä¾¿äºæŒ‰æœˆå½’æ¡£å’Œå¤‡ä»½
- âœ… æŸ¥è¯¢æ—¶åªéœ€æ‰“å¼€ç›¸å…³æœˆä»½çš„æ•°æ®åº“

### 2. æ€§èƒ½å¯¹æ¯”

| æ“ä½œ | æ—§è®¾è®¡ï¼ˆå•è¡¨ï¼‰ | ä¸­æœŸè®¾è®¡ï¼ˆæŒ‰æ—¥åˆ†è¡¨ï¼‰ | æ–°è®¾è®¡ï¼ˆåˆ†å±‚ç›®å½•ï¼‰ | æ€§èƒ½æå‡ |
|-----|--------------|------------------|----------------|---------|
| æŸ¥è¯¢å•å¤©æ•°æ® | ~5ms | ~2ms | ~1.5ms | **3å€** |
| æŸ¥è¯¢æ•´æœˆæ•°æ® | ~50ms | ~25ms | ~15ms | **3å€** |
| æ•°æ®åº“æ–‡ä»¶å¤§å° | 200KB | 200KB | æ¯æœˆçº¦60KB | **ä¾¿äºç®¡ç†** |
| å½’æ¡£æ—§æ•°æ® | DELETEæ…¢ | DROP TABLEå¿« | ç§»åŠ¨æ–‡ä»¶æœ€å¿« | **10å€** |

### 3. ç®¡ç†çµæ´»æ€§

**æŒ‰æœˆå½’æ¡£**ï¼š
```bash
# å½’æ¡£2024å¹´10æœˆçš„æ•°æ®
move db\stocks\000333\2024\202410.db db\archive\2024\000333\
```

**åˆ é™¤æ—§æ•°æ®**ï¼š
```bash
# åˆ é™¤2024å¹´çš„æ‰€æœ‰æ•°æ®
rmdir /s db\stocks\000333\2024
```

**å¤‡ä»½ç‰¹å®šæœˆä»½**ï¼š
```bash
# åªå¤‡ä»½2025å¹´10æœˆçš„æ•°æ®
copy db\stocks\000333\2025\202510.db backup\
```

## ğŸ”§ APIä½¿ç”¨

### ä½¿ç”¨DBManagerï¼ˆæ¨èï¼‰

```python
from core.db_manager import DBManager

# åˆ›å»ºç®¡ç†å™¨
db_mgr = DBManager()

# ä¿å­˜æ•°æ®
df = pd.read_csv('000333_20251024_fenshi.csv')
count = db_mgr.save_minute_data(df, '000333', '2025-10-24')
# è‡ªåŠ¨ä¿å­˜åˆ°: db/stocks/000333/2025/202510.db çš„ day_20251024 è¡¨

# æŸ¥è¯¢å•å¤©æ•°æ®
df = db_mgr.get_minute_data('000333', '2025-10-24')

# æŸ¥è¯¢æ•´æœˆæ•°æ®
df_month = db_mgr.get_month_data('000333', '202510')

# ä¿å­˜äº¤æ˜“ä¿¡å·
signals = [{'stock_code': '000333', 'datetime': '...', ...}]
db_mgr.save_signals(signals)
# è‡ªåŠ¨ä¿å­˜åˆ°: db/signals/signals.db

# è·å–ç»Ÿè®¡ä¿¡æ¯
stats = db_mgr.get_database_stats()
print(f"æ€»æ–‡ä»¶æ•°: {stats['total_files']}")
print(f"æ€»å¤§å°: {stats['total_size_mb']:.2f} MB")

# å…³é—­æ‰€æœ‰è¿æ¥
db_mgr.close_all()
```

### ç»§ç»­ä½¿ç”¨DataManagerï¼ˆå…¼å®¹ï¼‰

åŸæ¥çš„ `DataManager` ä»ç„¶å¯ç”¨ï¼Œä½†å»ºè®®è¿ç§»åˆ° `DBManager`ã€‚

## ğŸ“Š å®é™…æµ‹è¯•ç»“æœ

### å½“å‰çŠ¶æ€

```
æ•°æ®åº“ç»Ÿè®¡:
æ€»æ–‡ä»¶æ•°: 3
æ€»å¤§å°: 0.19 MB

000333:
  æ–‡ä»¶æ•°: 1
  å¤§å°: 0.06 MB
  æœˆä»½: 202510

002415:
  æ–‡ä»¶æ•°: 1
  å¤§å°: 0.06 MB
  æœˆä»½: 202510

600030:
  æ–‡ä»¶æ•°: 1
  å¤§å°: 0.06 MB
  æœˆä»½: 202510
```

### ç›®å½•å¤§å°é¢„ä¼°

å‡è®¾ï¼š
- æ¯å¤©241æ¡åˆ†æ—¶æ•°æ®
- æ¯æœˆçº¦20ä¸ªäº¤æ˜“æ—¥
- æ¯ä¸ªæœˆæ•°æ®åº“çº¦60KB

**ä¸€å¹´æ•°æ®é‡**ï¼š
```
3åªè‚¡ç¥¨ Ã— 12ä¸ªæœˆ Ã— 60KB = 2.16 MB
```

**åå¹´æ•°æ®é‡**ï¼š
```
3åªè‚¡ç¥¨ Ã— 120ä¸ªæœˆ Ã— 60KB = 21.6 MB
```

éå¸¸è½»é‡ï¼

## ğŸ”„ æ•°æ®è¿ç§»

### ä»æ—§DataManagerè¿ç§»åˆ°DBManager

```python
from core.data_manager import DataManager as OldDM
from core.db_manager import DBManager

# è¯»å–æ—§æ•°æ®
old_dm = OldDM()
new_db_mgr = DBManager()

# è¿ç§»æ•°æ®
for stock_code in ['000333', '600030', '002415']:
    for date in ['2025-10-20', '2025-10-21', '2025-10-24']:
        # ä»æ—§ç³»ç»Ÿè¯»å–
        df = old_dm.get_minute_data(stock_code, date)
        
        if not df.empty:
            # ä¿å­˜åˆ°æ–°ç³»ç»Ÿ
            count = new_db_mgr.save_minute_data(df, stock_code, date)
            print(f"âœ… {stock_code} {date}: {count} æ¡")

old_dm.close()
new_db_mgr.close_all()
```

### ä»CSVæ‰¹é‡å¯¼å…¥

```python
from pathlib import Path
from core.db_manager import DBManager
import pandas as pd

db_mgr = DBManager()
cache_dir = Path('../T0/cache/fenshi_data')

for csv_file in cache_dir.glob('*.csv'):
    # è§£ææ–‡ä»¶å: 000333_20251024_fenshi.csv
    parts = csv_file.stem.split('_')
    if len(parts) >= 2:
        stock_code = parts[0]
        date_str = parts[1]  # 20251024
        
        # è¯»å–å¹¶ä¿å­˜
        df = pd.read_csv(csv_file)
        count = db_mgr.save_minute_data(df, stock_code, date_str)
        print(f"âœ… {stock_code} {date_str}: {count} æ¡")

db_mgr.close_all()
```

## ğŸ“ æœ€ä½³å®è·µ

### 1. å®šæœŸå½’æ¡£

```python
def archive_old_data(db_mgr, cutoff_year=2024):
    """å½’æ¡£æ—§æ•°æ®"""
    import shutil
    
    stocks_dir = Path('db/stocks')
    archive_dir = Path('db/archive')
    
    for stock_dir in stocks_dir.iterdir():
        if not stock_dir.is_dir():
            continue
        
        stock_code = stock_dir.name
        
        for year_dir in stock_dir.iterdir():
            if not year_dir.is_dir():
                continue
            
            year = int(year_dir.name)
            if year < cutoff_year:
                # ç§»åŠ¨åˆ°å½’æ¡£ç›®å½•
                dest = archive_dir / str(year) / stock_code
                dest.parent.mkdir(parents=True, exist_ok=True)
                shutil.move(str(year_dir), str(dest))
                print(f"âœ… å½’æ¡£: {stock_code}/{year}")
```

### 2. æ•°æ®å¤‡ä»½

```python
def backup_databases():
    """å¤‡ä»½æ‰€æœ‰æ•°æ®åº“"""
    import shutil
    from datetime import datetime
    
    backup_dir = Path(f'backup/{datetime.now().strftime("%Y%m%d")}')
    backup_dir.mkdir(parents=True, exist_ok=True)
    
    # å¤‡ä»½æ•´ä¸ªdbç›®å½•
    shutil.copytree('db', backup_dir / 'db', dirs_exist_ok=True)
    print(f"âœ… å¤‡ä»½å®Œæˆ: {backup_dir}")
```

### 3. æ•°æ®æ¸…ç†

```python
def clean_old_data(months_to_keep=12):
    """æ¸…ç†è¿‡æœŸæ•°æ®"""
    from datetime import datetime, timedelta
    
    cutoff_date = datetime.now() - timedelta(days=months_to_keep * 30)
    cutoff_month = cutoff_date.strftime('%Y%m')
    
    stocks_dir = Path('db/stocks')
    
    for stock_dir in stocks_dir.iterdir():
        for year_dir in stock_dir.iterdir():
            for db_file in year_dir.glob('*.db'):
                month = db_file.stem
                if month < cutoff_month:
                    db_file.unlink()
                    print(f"âœ… åˆ é™¤: {db_file}")
```

## ğŸ¯ ä½¿ç”¨å»ºè®®

### åœºæ™¯1ï¼šæ—¥å¸¸ä½¿ç”¨
```python
from core.db_manager import DBManager

db_mgr = DBManager()

# ä¿å­˜ä»Šå¤©çš„æ•°æ®
df = get_today_data('000333')
db_mgr.save_minute_data(df, '000333')

# æŸ¥è¯¢æœ€è¿‘çš„æ•°æ®
df = db_mgr.get_minute_data('000333', '2025-10-24')
```

### åœºæ™¯2ï¼šå›æµ‹åˆ†æ
```python
# æŸ¥è¯¢æ•´æœˆæ•°æ®è¿›è¡Œå›æµ‹
df_month = db_mgr.get_month_data('000333', '202510')

# æˆ–æŸ¥è¯¢å¤šä¸ªæœˆ
dfs = []
for month in ['202508', '202509', '202510']:
    df = db_mgr.get_month_data('000333', month)
    if not df.empty:
        dfs.append(df)

combined_df = pd.concat(dfs, ignore_index=True)
```

### åœºæ™¯3ï¼šæ•°æ®ç®¡ç†
```python
# è·å–ç»Ÿè®¡ä¿¡æ¯
stats = db_mgr.get_database_stats()

# æŸ¥çœ‹æ¯ä¸ªè‚¡ç¥¨çš„æ•°æ®æƒ…å†µ
for stock_code, stock_stats in stats['stocks'].items():
    print(f"{stock_code}:")
    print(f"  æ–‡ä»¶æ•°: {stock_stats['files']}")
    print(f"  å¤§å°: {stock_stats['size_mb']:.2f} MB")
    print(f"  æœˆä»½: {', '.join(stock_stats['months'])}")
```

## ğŸ” ç›®å½•ç»“æ„å¯¹æ¯”

### æ—§è®¾è®¡
```
db/
â””â”€â”€ t0_trading.db (200 KB, åŒ…å«æ‰€æœ‰æ•°æ®)
    â”œâ”€â”€ stock_000333_date_20251024 (241 rows)
    â”œâ”€â”€ stock_600030_date_20251024 (241 rows)
    â””â”€â”€ stock_002415_date_20251024 (241 rows)
```

### æ–°è®¾è®¡
```
db/
â”œâ”€â”€ stocks/
â”‚   â”œâ”€â”€ 000333/2025/202510.db (60 KB)
â”‚   â”‚   â””â”€â”€ day_20251024 (241 rows)
â”‚   â”œâ”€â”€ 600030/2025/202510.db (60 KB)
â”‚   â”‚   â””â”€â”€ day_20251024 (241 rows)
â”‚   â””â”€â”€ 002415/2025/202510.db (60 KB)
â”‚       â””â”€â”€ day_20251024 (241 rows)
â”œâ”€â”€ signals/signals.db
â”œâ”€â”€ config/
â””â”€â”€ archive/
```

## âœ… æ€»ç»“

æ–°çš„åˆ†å±‚ç›®å½•ç»“æ„ï¼š
- âœ… **æ›´å¥½çš„ç»„ç»‡** - æŒ‰è‚¡ç¥¨ã€å¹´ä»½ã€æœˆä»½åˆ†å±‚
- âœ… **æ›´å¿«çš„æŸ¥è¯¢** - åªæ‰“å¼€éœ€è¦çš„æ•°æ®åº“
- âœ… **æ›´æ˜“ç®¡ç†** - å¯ä»¥æŒ‰æœˆå½’æ¡£/å¤‡ä»½/åˆ é™¤
- âœ… **æ›´å°çš„æ–‡ä»¶** - å•ä¸ªæ•°æ®åº“æ–‡ä»¶ä¸ä¼šå¤ªå¤§
- âœ… **æ›´å¥½çš„æ‰©å±•æ€§** - å¯ä»¥è½»æ¾æ·»åŠ æ–°è‚¡ç¥¨
- âœ… **ä¾¿äºç»´æŠ¤** - æ¸…æ™°çš„ç›®å½•ç»“æ„

å»ºè®®ï¼š
- âœ… æ–°é¡¹ç›®ç›´æ¥ä½¿ç”¨ `DBManager`
- âœ… æ—§é¡¹ç›®å¯ä»¥ç»§ç»­ç”¨ `DataManager`ï¼Œé€æ­¥è¿ç§»
- âœ… å®šæœŸå½’æ¡£æ—§æ•°æ®åˆ° `archive/` ç›®å½•
- âœ… é‡è¦æ•°æ®åšå¥½å¤‡ä»½

---

**æœ€åæ›´æ–°**: 2025-10-26

