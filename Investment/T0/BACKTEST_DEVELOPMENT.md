# T0策略回测系统开发文档

## 项目概述

本项目为T0交易系统开发了一个完整的回测框架，用于测试和评估各种技术指标在历史数据上的表现。该系统支持三种主要的技术指标：

1. **阻力支撑指标** - 基于通达信公式的支撑位和阻力位策略
2. **扩展指标** - 包含MACD、移动平均线等多种技术指标的综合策略
3. **量价指标** - 基于成交量和价格关系的交易策略

## 系统架构

```
T0/
├── backtest/                # 回测系统模块
│   ├── __init__.py          # 包初始化文件
│   ├── config.py           # 回测配置参数
│   ├── models.py           # 数据模型定义
│   ├── data_loader.py      # 数据加载模块
│   ├── strategies.py       # 策略实现模块
│   ├── engine.py           # 回测引擎
│   └── main.py             # 主程序入口
├── indicators/             # 指标计算模块
│   ├── resistance_support_indicators.py
│   ├── extended_indicators.py
│   └── volume_price_indicators.py
└── ...
```

## 开发过程

### 1. 问题识别与修复

在开发过程中，我们遇到了以下问题并进行了修复：

#### 1.1 阻力支撑指标函数返回None的问题

**问题描述：**
在`resistance_support_indicators.py`文件中，`calculate_tdx_indicators`函数由于缩进错误导致提前返回None。

**修复方法：**
调整了函数末尾的缩进，确保函数在完成所有计算后才返回结果。

#### 1.2 量价指标缺少必要列的问题

**问题描述：**
在`volume_price_indicators.py`文件中，部分计算依赖的列（如"主力"、"大户"、"散户"）可能不存在，导致KeyError异常。

**修复方法：**
在计算前检查并确保必要的列存在，如果不存在则初始化为0。

#### 1.3 模块导入路径问题

**问题描述：**
在回测模块中存在相对导入和绝对导入混用的问题，导致模块无法正确加载。

**修复方法：**
统一使用相对导入方式，确保模块可以正确加载。

### 2. 功能实现

#### 2.1 数据加载模块

实现了从akshare获取历史分时数据的功能，并添加了缓存机制以提高重复测试的效率。

#### 2.2 策略模块

实现了三种技术指标的信号检测功能：
- 阻力支撑指标信号检测
- 扩展指标信号检测
- 量价指标信号检测

#### 2.3 回测引擎

实现了完整的回测流程：
- 信号检测
- 交易执行（考虑手续费和滑点）
- 绩效计算
- 结果保存和可视化

### 3. 测试验证

我们创建了多个测试脚本来验证系统的功能：

#### 3.1 单指标测试 (`test_single_indicator.py`)

专门用于测试单个指标在单个交易日上的表现，输出详细的信号信息。

#### 3.2 简化版回测 (`simple_backtest.py`)

对整个回测期间进行测试，输出基本的绩效指标。

#### 3.3 详细日志版回测 (`detailed_backtest.py`)

提供最详细的回测信息，包括每个信号和交易的详细信息。

## 使用方法

### 基本使用

```bash
# 运行简化版回测
python simple_backtest.py

# 运行详细日志版回测
python detailed_backtest.py

# 测试单个指标
python test_single_indicator.py
```

### 自定义参数

可以通过修改脚本中的参数来自定义回测：

```python
# 在脚本中修改以下参数
stock_code = '000333'  # 股票代码
start_date = '20250901'  # 开始日期
end_date = '20250930'    # 结束日期
```

## 输出结果

回测系统会生成以下输出：

1. **控制台日志** - 显示详细的回测过程和结果
2. **CSV文件** - 保存详细的回测结果数据
3. **图表文件** - 生成回测结果的可视化分析图表

文件保存在 `backtest/results/` 目录下。

## 性能指标

系统计算并输出以下关键绩效指标：

1. **收益率** - 策略的总收益率
2. **胜率** - 盈利交易占总交易数的比例
3. **交易次数** - 策略产生的交易信号数量
4. **初始资金和最终资金** - 资金变化情况

## 扩展性

系统设计具有良好的扩展性，可以轻松添加新的技术指标：

1. 在`strategies.py`中实现新的信号检测函数
2. 在`engine.py`的`run_backtest`方法中添加对应的条件分支
3. 在测试脚本中添加新的指标类型

## 总结

通过本次开发，我们成功构建了一个功能完整的T0策略回测系统，可以有效测试和评估各种技术指标在历史数据上的表现。系统具有良好的可扩展性和易用性，为后续的策略优化和新策略开发提供了坚实的基础。