<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>设备轨迹 - {{ device_id }}</title>
    <script src="https://api.map.baidu.com/api?v=3.0&ak={{ ak }}"></script>
    <style>
        #map { height: 600px; width: 100%; }
        .info { padding: 20px; }
    </style>
</head>
<body>
    <div class="info">
        <h2>设备ID: {{ device_id }}</h2>
        <button onclick="loadPath()">刷新轨迹</button>
    </div>
    <div id="map"></div>

    <script>
        let map = new BMap.Map("map");
        map.centerAndZoom(new BMap.Point(116.404, 39.915), 11);
        map.enableScrollWheelZoom(true);

        function loadPath() {
            fetch(`/api/points/${encodeURIComponent("{{ device_id }}")}`)
                .then(res => res.json())
                .then(points => {
                    map.clearOverlays();

                    // 绘制轨迹
                    const trackPoints = points.map(p =>
                        new BMap.Point(p.lng, p.lat)
                    );

                    new BMap.Polyline(trackPoints, {
                        strokeColor: "#ff0000",
                        strokeWeight: 3
                    }).addTo(map);

                    // 添加标记点
                    points.forEach((p, i) => {
                        const marker = new BMap.Marker(
                            new BMap.Point(p.lng, p.lat)
                        );
                        const date = new Date(p.timestamp * 1000);
                        marker.setLabel(new BMap.Label(
                            `点位${i+1}<br>${date.toLocaleString()}`
                        ));
                        map.addOverlay(marker);
                    });

                    map.setViewport(trackPoints);
                });
        }

        // 初始加载
        loadPath();
    </script>
</body>
</html>